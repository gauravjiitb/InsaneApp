{% extends "base_staff.html" %}
{% load static %}
{% load bootstrap4 %}
{% load widget_tweaks %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container w-75 p-3">
  <br>
  <div class="jumbotron">
    <h2 align='center'>Please fill the details below.</h2>
    <br>

    <form method="POST" id="quoteForm" data-cities-url="{% url 'SalesApp:ajax_quote_load_cities' %}"
                                       data-hotels-url="{% url 'SalesApp:ajax_quote_load_hotels' %}"
                                       data-transfers-url="{% url 'SalesApp:ajax_quote_load_transfers' %}"
                                       data-sightseeings-url="{% url 'SalesApp:ajax_quote_load_sightseeings' %}" novalidate>
    {% csrf_token %}
    {% if view_error %}{{ view_error }}{% endif %}
    {% if form.errors %}{{quote_form.non_field_errors}}{% endif %}
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            {{ quote_form.lead|as_crispy_field }}
            {{ quote_form.title|as_crispy_field }}
            {{ quote_form.starting_place|as_crispy_field }}
            {{ quote_form.adults|as_crispy_field }}
            {{ quote_form.children|as_crispy_field }}
            {{ quote_form.children_age|as_crispy_field }}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            {{ quote_form.start_date|as_crispy_field }}
            {{ quote_form.end_date|as_crispy_field }}
            {{ quote_form.destinations|as_crispy_field }}
            {{ quote_form.cities|as_crispy_field }}
          </div>
        </div>
      </div>
    </div>
    <br>
    <button class="btn btn-primary btn-lg float-right mx-5 px-5" name="redirect" value="True" type="submit">Save</button>
    <button class="btn btn-primary btn-lg float-right" name="redirect" value="False" type="submit">Save and Continue Editing</button>


    </div>
    </div>


<div class="">
  <div class="jumbotron">

    <div class="card">
      <div class="card-body">
        <h6>Hotel Details</h6>
        <hr>
          {{ hotel_formset.management_form|crispy }}
          {% for form in hotel_formset %}
            <div class="hotel-selections row justify-content-center">
              {% for field in form %}
                <div class="col"> {{ field|as_crispy_field }}</div>
              {% endfor %}
            </div>
          {% endfor %}
      </div>
    </div>

    <br>

    <div class="card">
      <div class="card-body">
        <h6>Transfer Details</h6>
        <hr>
          {{ transfer_formset.management_form|crispy }}
          {% for form in transfer_formset %}
            <div class="transfer-selections row justify-content-center">
              {% for field in form %}
                <div class="col"> {{ field|as_crispy_field }}</div>
              {% endfor %}
            </div>
          {% endfor %}
      </div>
    </div>

    <br>

    <div class="card">
      <div class="card-body">
        <h6>Sightseeing Details</h6>
        <hr>
          {{ sightseeing_formset.management_form|crispy }}
          {% for form in sightseeing_formset %}
            <div class="sightseeing-selections row justify-content-center">
              {% for field in form %}
                <div class="col"> {{ field|as_crispy_field }}</div>
              {% endfor %}
            </div>
          {% endfor %}
      </div>
    </div>

    <br>

    <div class="card">
      <div class="card-body">
        <h6>Visa, Insurance Details</h6>
        <hr>
          {{ visa_formset.management_form|crispy }}
          {% for form in visa_formset %}
            <div class="visa-insurance-selections row justify-content-center">
              {% for field in form %}
                <div class="col"> {{ field|as_crispy_field }}</div>
              {% endfor %}
            </div>
          {% endfor %}
          <hr>
          {{ insurance_formset.management_form|crispy }}
          {% for form in insurance_formset %}
            <div class="visa-insurance-selections row justify-content-center">
              {% for field in form %}
                <div class="col"> {{ field|as_crispy_field }}</div>
              {% endfor %}
            </div>
          {% endfor %}
      </div>
    </div>

    <br>
    <div class="row">
      <div class="col">
        <br>
        <button class="btn btn-primary btn-lg float-right mx-5 px-5" name="redirect" value="True" type="submit">Save</button>
        <button class="btn btn-primary btn-lg float-right" name="redirect" value="False" type="submit">Save and Continue Editing</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="jumbotron">
    <h6>Itinerary Details</h6>
    <hr>
    <small>To organize the itinerary, drag the items from right container to respective days in left container.
      Itinerary can only be organized after you have selected the inclusions.</small>
    <hr>

    <div class="row">
      <div class="col">
        <h6>Day to day Itinerary</h6>
        {% for object_list in itinerary_objects_list %}
        <div class="card itinerary-card">
          <p>Day {{forloop.counter}}</p>
          <div class="sortable included-elements card-body">
            {% for object in object_list %}
              {% if object.transfer %}
                <p class="draggable d-block p-2 m-1 bg-secondary text-white" id="transfer-{{object.id}}">{{ object.transfer }}</p>
              {% endif %}
              {% if object.sightseeing %}
                <p class="draggable d-block p-2 m-1 bg-secondary text-white" id="sightseeing-{{object.id}}">{{ object.sightseeing }}</p>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="col">
        <h6>All Transfers and Sightseeing</h6>
        <div class="card">
          <div class=" sortable card-body">
            {% for object in itinerary_choices_objects_list %}
              {% if object.transfer %}
                <p class="draggable d-block p-2 m-1 bg-secondary text-white" id="transfer-{{object.id}}">{{ object.transfer }}</p>
              {% endif %}
              {% if object.sightseeing %}
                <p class="draggable d-block p-2 m-1 bg-secondary text-white" id="sightseeing-{{object.id}}">{{ object.sightseeing }}</p>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

    </div>

    <div class="row">
      {{ itinerary_formset.management_form|crispy }}
      {% for form in itinerary_formset %}
        <div class="itinerary-selections row justify-content-center d-none">
          {% for field in form %}
            <div class="col"> {{ field|as_crispy_field }}</div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

    <div class="row">
      <div class="col">
        <br>
        <button class="btn btn-primary btn-lg float-right mx-5 px-5" name="redirect" value="True" type="submit">Save</button>
        <button class="btn btn-primary btn-lg float-right" name="redirect" value="False" type="submit">Save and Continue Editing</button>
        </form>
      </div>
    </div>

  </div>
</div>


<script src="{% static "js/salesapp_quote_form.js" %}"></script>

<script>
// THIS SCRIPT COPIES THE ORDER OF ELEMENTS IN ITINERARY AND COPIES IT TO ITINERARY FORMSET.
$( function() {
  $( ".sortable" ).sortable({
    revert: true
  });
  $( ".draggable" ).draggable({
    connectToSortable: ".sortable",
    revert: "invalid"
  });
  $(".sortable").on("sortreceive", function(event,ui){
    var i=0;
    $(".sortable.included-elements").each(function(){
      var x = $(this).sortable("toArray");
      console.log(x);
      $("input[name*="+i+"-ordering]").val(x);
      i = i + 1;
    });
  });
  $( ".draggable" ).disableSelection();
});
</script>


<script>
  var city_ids = $("#id_cities").val()
  template = "<option value=''>---------</option>"
  for (var i = 0; i < city_ids.length; i++) {
    city = $("#id_cities option[value="+city_ids[i]+"]").text()
    template += `<option value='${city_ids[i]}'>${city}</option>`
  }

  $("select[id*='city']").each(function(index){
    if ( !($(this).val() > 0) ) {
      $(this).html(template);
    }
  });
</script>

{% endblock %}
